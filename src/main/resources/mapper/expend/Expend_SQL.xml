<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Expend">

    <select id="getDocListData" parameterType="map" resultType="map">
        SELECT
            DI.DOC_ID, DI.APPRO_KEY, DI.DOC_NO, DI.DOC_TITLE, RS.RES_DOC_SEQ, DI.DRAFT_EMP_NAME
        FROM DJ_EPIS.A_DOC_INFO DI
        JOIN NEOS.T_EXNP_RESDOC RS
        ON DI.DOC_ID = RS.DOC_SEQ
        WHERE DI.APPRO_KEY LIKE '%EXNPRESI_NP%'
        AND DI.APPROVE_STAT_CODE IN('100', '101')
        AND DI.ACTIVE = 'Y'
        AND DI.DEL_FLAG = 'N'
        <if test="searchDocNo != null and searchDocNo != ''">
            AND DI.DOC_NO LIKE CONCAT('%', #{searchDocNo}, '%')
        </if>
        <if test="searchDocTitle != null and searchDocTitle != ''">
            AND DI.DOC_TITLE LIKE CONCAT('%', #{searchDocTitle}, '%')
        </if>
        <if test="searchDraftEmpName != null and searchDraftEmpName != ''">
            AND DI.DRAFT_EMP_NAME LIKE CONCAT('%', #{searchDraftEmpName}, '%')
        </if>
    </select>

    <select id="getDocListDataTotalCount" parameterType="map" resultType="String">
        SELECT
            COUNT(*)
        FROM DJ_EPIS.A_DOC_INFO DI
        JOIN NEOS.T_EXNP_RESDOC RS
        ON DI.DOC_ID = RS.DOC_SEQ
        WHERE DI.APPRO_KEY LIKE '%EXNPRESI_NP%'
        AND DI.APPROVE_STAT_CODE IN('100', '101')
        AND DI.ACTIVE = 'Y'
        AND DI.DEL_FLAG = 'N'
        <if test="searchDocNo != null and searchDocNo != ''">
            AND DI.DOC_NO LIKE CONCAT('%', #{searchDocNo}, '%')
        </if>
        <if test="searchDocTitle != null and searchDocTitle != ''">
            AND DI.DOC_TITLE LIKE CONCAT('%', #{searchDocTitle}, '%')
        </if>
        <if test="searchDraftEmpName != null and searchDraftEmpName != ''">
            AND DI.DRAFT_EMP_NAME LIKE CONCAT('%', #{searchDraftEmpName}, '%')
        </if>
    </select>

    <select id="getResTradeList" parameterType="map" resultType="map">
        SELECT
            TR.RES_DOC_SEQ, TR.RES_SEQ, TR.TRADE_SEQ, TR.TR_NAME, TR.CTR_NAME, FORMAT(TR.TRADE_AMT, 0) AS TRADE_AMT
        FROM
            NEOS.T_EXNP_RESTRADE TR
        WHERE TR.RES_DOC_SEQ = #{RES_DOC_SEQ}
    </select>

    <update id="updateCardTrade" parameterType="map">
        UPDATE NEOS.T_EX_CARD_AQ_TMP
        SET IF_M_ID = #{resDocSeq}, IF_D_ID = #{tradeSeq}, SEND_YN = 'Y'
        WHERE SYNC_ID = #{syncId}
    </update>

    <update id="updateTradeCard" parameterType="map">
        UPDATE NEOS.T_EXNP_RESTRADE
        SET INTERFACE_TYPE = 'card', INTERFACE_SEQ = #{syncId}
        WHERE TRADE_SEQ = #{tradeSeq}
    </update>

    <select id="getTradeMap" parameterType="map" resultType="map">
        SELECT
            *
        FROM
            NEOS.T_EXNP_RESTRADE
        WHERE TRADE_SEQ = #{tradeSeq}
    </select>

    <select id="getCardMap" parameterType="map" resultType="map">
        SELECT
            *
        FROM
            NEOS.T_EX_CARD_AQ_TMP
        WHERE SYNC_ID = #{syncId}
    </select>

    <insert id="insertTradeCardHistory" parameterType="map">
        INSERT INTO DJ_EPIS.V_TRADE_CARD_HISTORY
        (
            prev_interface_type,
            prev_interface_seq,
            next_interface_type,
            next_interface_seq,
            prev_if_d_id,
            prev_if_m_id,
            next_if_d_id,
            next_if_m_id,
            reg_seq,
            reg_date
        )
        VALUES
        (
            #{prev_interface_type},
            #{prev_interface_seq},
            #{next_interface_type},
            #{next_interface_seq},
            #{prev_if_d_id},
            #{prev_if_m_id},
            #{next_if_d_id},
            #{next_if_m_id},
            #{reg_seq},
            now()
        )
    </insert>

    <update id="setCardMoney" parameterType="map">
        UPDATE NEOS.T_EX_CARD_AQ_TMP
        SET REQUEST_AMOUNT = #{modifyReqAmt}, AMT_MD_AMOUNT = #{modifySerAmount}, VAT_MD_AMOUNT = #{modifyVatAmt}
        WHERE SYNC_ID = #{syncId}
    </update>

    <insert id="setCardModifyLog" parameterType="map">
        INSERT INTO DJ_EPIS.V_CARD_MODIFY_LOG
        (
            sync_id,
            auth_num,
            card_num,
            card_name,

            prev_georae_stat,
            prev_req_amt,
            prev_ser_amount,
            prev_vat_amt,

            modify_georae_stat,
            modify_req_amt,
            modify_ser_amount,
            modify_vat_amt,
            reg_date,
            reg_seq,
            reg_name
        )
        VALUES
        (
            #{syncId},
            #{authNum},
            #{cardNum},
            #{cardName},
            #{georaeStat},
            #{reqAmt},
            #{serAmount},
            #{vatAmt},
            #{modifyGeoraeStat},
            #{modifyReqAmt},
            #{modifySerAmount},
            #{modifyVatAmt},
            NOW(),
            #{regSeq},
            #{regName}
        )
    </insert>
</mapper>