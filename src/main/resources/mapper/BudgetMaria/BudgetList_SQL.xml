<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="BudgetMaria">
	
	<select id="BudgetMaria.getPreBudgetInfo" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT   b.abgt_cd                                                                                             as abgtCd
		       , sum(case when b.abdocu_no_reffer is not null then -1 else 1 end * b.apply_am) + ifnull(r.apply_am, 0) as applyAm
		FROM       neos.g20_abdocu_h h
		INNER JOIN neos.g20_abdocu_b b ON h.abdocu_no = b.abdocu_no
		INNER JOIN neos.a_draftinfo  e ON h.C_DIKEYCODE = e.C_DIKEYCODE
         LEFT JOIN neos.g20_abdocu_b r ON b.abdocu_no = r.abdocu_no AND r.abgt_cd is null
		WHERE e.C_DISTATUS IN ('002', '003', '008', '009')
		  AND h.erp_co_cd   = #{coCd}
		  AND h.erp_div_cd  = #{divCd}
		  AND h.mgt_cd      = #{pjtCd}
		  AND h.bottom_cd   = #{btmCd}
		  AND b.abgt_cd     = #{bgtCd}
		  <!-- AND h.erp_gisu_dt like concat(#{bgtYm}, '%') -->
		  AND DATE_FORMAT(h.erp_gisu_dt, '%Y%m') BETWEEN #{reqMonthFr} AND #{reqMonthTo}
		  AND (B.DOCU_MODE = '0' OR B.ABDOCU_NO_REFFER IS NOT NULL)
		  <![CDATA[
    		AND 0 <> (SELECT COUNT(*) 
    		]]>
              FROM   neos.g20_abdocu_t T
              WHERE  T.abdocu_no = B.abdocu_no
              AND    T.abdocu_b_no = B.abdocu_b_no)
		GROUP BY b.abgt_cd
	</select>
	
	<select id="BudgetMaria.getPreBudgetInfoCons" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT 
			/*+ INDEX(H IDX_G20_ABDOCU_H_MGT_CD )  INDEX(B IDX_G20_ABDOCU_B_BGT_CD) */
			(
				CASE 	(SELECT	MAX(CODE) IS NULL FROM	neos.t_co_code WHERE	CODE = 'EXNP_VAT01') 
					WHEN	1 THEN	IFNULL(SUM(IFNULL(T.UNIT_AM,0)),0)
					/* 부산항 처리 필요함. */
					ELSE	IFNULL(SUM(IFNULL(T.UNIT_AM,0)),0) - IFNULL(SUM(IFNULL(T.VAT_AM,0)),0)
				END
			)	AS APPLY_AM
			, IFNULL(SUM(IFNULL(OPEN_AM, 0)),0) AS OPEN_AM
			, IFNULL(SUM(IFNULL(OPEN_AM, 0)) - SUM(IFNULL(APPLY_AM,0)),0) AS LEFT_AM
		FROM 	neos.G20_ABDOCU_H H
		 JOIN 	neos.G20_ABDOCU_B B
		 ON 		H.ABDOCU_NO = B.ABDOCU_NO
		  AND 	C_DIKEYCODE IS NOT NULL
		  AND		H.DOCU_MODE = '0'
		  AND     H.ERP_CO_CD = #{coCd}
		  AND     H.ERP_DIV_CD = #{divCd} 
		  AND		H.MGT_CD 	= #{pjtCd}
          AND		H.BOTTOM_CD = #{btmCd}
		  AND		B.ABGT_CD 	= #{bgtCd}
		  AND 	DATE_FORMAT(H.ERP_GISU_DT, '%Y%m') BETWEEN #{reqMonthFr} AND #{reqMonthTo}
		 JOIN	    neos.ERPGWLINK LINK
		 ON		LINK.APPR_DIKEY =  H.C_DIKEYCODE
		  AND		IFNULL(APPR_STATUS, '008') IN ('002', '003', '008', '009')   
		INNER JOIN	neos.A_DRAFTINFO DI
		 ON		H.C_DIKEYCODE = DI.C_DIKEYCODE		 
		 AND     IFNULL(DI.C_DISTATUS, '008') IN ('002', '003', '008', '009')         
		INNER JOIN	(
			SELECT	abdocu_no, MIN(IFNULL(abgt_cd, -1))	confferReturn
			FROM 	neos.g20_abdocu_b 
			GROUP BY abdocu_no
			HAVING 	confferReturn != -1
		)	B2
		 ON	B.abdocu_no = B2.abdocu_no         
        LEFT JOIN	neos.G20_ABDOCU_T T
		ON	B.abdocu_b_no = T.abdocu_b_no
		AND	B.abdocu_no = T.abdocu_no
	</select>
	
	<select id="BudgetMaria.getPreBudgetInfoRes" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT	/*+ INDEX(H IDX_G20_ABDOCU_H_MGT_CD )  INDEX(B IDX_G20_ABDOCU_B_BGT_CD) */
				(
					CASE 	(SELECT	MAX(CODE) IS NULL FROM	neos.t_co_code WHERE	CODE = 'EXNP_VAT01') 
						WHEN	1 THEN	IFNULL(SUM(IFNULL(T.UNIT_AM,0)),0)
						ELSE	IFNULL(SUM(IFNULL(T.UNIT_AM,0)),0) - IFNULL(SUM(IFNULL(T.VAT_AM,0)),0)
					END
				)	AS APPLY_AM,
				IFNULL(SUM(IFNULL(B.OPEN_AM, 0)),0) AS OPEN_AM,
				IFNULL(SUM(IFNULL(B.OPEN_AM, 0)) - SUM(IFNULL(T.UNIT_AM,0)),0)  AS LEFT_AM
		FROM 	neos.G20_ABDOCU_H H
		JOIN 	neos.G20_ABDOCU_B B
		ON		H.ABDOCU_NO		= B.ABDOCU_NO
		AND		C_DIKEYCODE IS NOT NULL
		AND		H.ABDOCU_NO_REFFER IS NOT NULL
		 AND		H.DOCU_MODE = '1'
		  AND     H.ERP_CO_CD = #{coCd}
		  AND     H.ERP_DIV_CD = #{divCd} 
		  AND		H.MGT_CD 	= #{pjtCd}
          AND		H.BOTTOM_CD = #{btmCd}
		  AND		B.ABGT_CD 	= #{bgtCd}
		  AND 	DATE_FORMAT(H.ERP_GISU_DT, '%Y%m') BETWEEN #{reqMonthFr} AND #{reqMonthTo}
		JOIN	    neos.ERPGWLINK LINK
		ON 		LINK.APPR_DIKEY	=  H.C_DIKEYCODE
		AND		IFNULL(APPR_STATUS, '008') IN ('002', '003', '008', '009')
		INNER JOIN	neos.g20_abdocu_b b2
		ON	b2.abdocu_b_no = b.abdocu_b_no_reffer
		INNER JOIN	(
			SELECT	abdocu_no, MIN(IFNULL(abgt_cd, -1))	confferReturn
			FROM 	neos.g20_abdocu_b 
			GROUP BY abdocu_no
			HAVING 	confferReturn != -1
		 )	B3
		 ON	B2.abdocu_no = B3.abdocu_no           
        JOIN	neos.G20_ABDOCU_T T
		ON	B.abdocu_b_no = T.abdocu_b_no
		AND	B.abdocu_no = T.abdocu_no
	</select>
	
	<select id="BudgetMaria.getDeptInfo" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT   a.dept_seq
		       , b.dept_name
		FROM       t_bgt_bottom_dept a
		INNER JOIN neos.t_co_dept_multi       b ON a.dept_seq = b.dept_seq AND b.lang_code = 'kr'
		WHERE a.pjt_cd    = #{pjtCd}
		  AND a.bottom_cd = #{btmCd}
	</select>
	
	<select id="BudgetMaria.getBtmInfoList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT IFNULL(CONCAT(GROUP_CONCAT(bottom_cd SEPARATOR '|'),'|'), '') AS btmCd
		FROM   t_bgt_bottom_dept 
		WHERE  dept_seq IN (${deptSeq})
		  AND  use_yn   = 'Y'
	</select>
	
	<select id="BudgetMaria.getBtmDeptInfo" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT   b.dept_name AS deptNm
		       , b.dept_seq  AS deptSeq
		FROM       t_bgt_bottom_dept a
		INNER JOIN neos.t_co_dept_multi       b ON a.dept_seq = b.dept_seq  
		WHERE  a.pjt_cd    = #{pjtCd}
		  AND  a.bottom_cd = #{btmCd}
		  AND  a.use_yn    = 'Y'
		  AND  b.use_yn    = 'Y'
	</select>
	
	<insert id="BudgetMaria.insertDept" parameterType="java.util.HashMap">
		INSERT INTO t_bgt_bottom_dept (
			  pjt_cd
			, bottom_cd
			, dept_seq
			, use_yn
			, create_seq
			, create_dt
			, modify_seq
			, modify_dt
		)
		VALUES (
			  #{pjtCd}
			, #{btmCd}
			, #{deptSeq}
			, 'Y'
			, #{empSeq}
			, now()
			, #{empSeq}
			, now()
		)
	</insert>
	
	<update id="BudgetMaria.updateDept" parameterType="java.util.HashMap">
		UPDATE t_bgt_bottom_dept SET
			  dept_seq   = #{deptSeq}
			, modify_seq = #{empSeq}
			, modify_dt  = now()
		WHERE  pjt_cd    = #{pjtCd}
		  AND  bottom_cd = #{btmCd}
		  AND  use_yn    = 'Y'
	</update>
	
	<select id="BudgetMaria.getBudgetCnt" parameterType="java.util.HashMap" resultType="java.lang.Integer">
		SELECT COUNT(*) AS budgetCnt
		FROM   dj_budget_apply
		WHERE  co_cd     = #{CO_CD}
		  AND  bgt_ym    = #{YYYY_MM}
		  AND  div_cd    = #{DIV_CD}
		  AND  mgt_cd    = #{MGT_CD}
		  AND  bottom_cd = #{BOTTOM_CD}
		  AND  bgt_cd    = #{BGT_CD}
	</select>
	
	<insert id="BudgetMaria.insertBudget" parameterType="java.util.HashMap">
		INSERT INTO dj_budget_apply (
			  co_cd
			, bgt_ym
			, div_cd
			, div_nm
			, mgt_cd
			, mgt_nm
			, bottom_cd
			, bottom_nm
			, dept_cd
			, dept_nm
			, bgt_cd
			, bgt_nm
			, bgt_nm1
			, bgt_nm2
			, bgt_nm3
			, bgt_amt1
			, bgt_amt2
			, apply_amt1
			, apply_amt2
		)
		VALUES (
			  #{CO_CD}
			, #{YYYY_MM}
			, #{DIV_CD}
			, #{DIV_NM}
			, #{MGT_CD}
			, #{MGT_NM}
			, #{BOTTOM_CD}
			, #{BOTTOM_NM}
			, #{DEPT_CD}
			, #{DEPT_NM}
			, #{BGT_CD}
			, #{BGT_NM}
			, #{BGT_NM1}
			, #{BGT_NM2}
			, #{BGT_NM3}
			, #{BGT_AM1}
			, #{BGT_AM2}
			, #{APPLY_AM}
			, #{APPLY_AM2}
		)
	</insert>
	
	<update id="BudgetMaria.updateBudget" parameterType="java.util.HashMap">
		UPDATE dj_budget_apply SET
			  bgt_amt1   = #{BGT_AM1}
			, bgt_amt2   = #{BGT_AM2}
			, apply_amt1 = #{APPLY_AM}
			, apply_amt2 = #{APPLY_AM2}
		WHERE  co_cd     = #{CO_CD}
		  AND  bgt_ym    = #{YYYY_MM}
		  AND  div_cd    = #{DIV_CD}
		  AND  mgt_cd    = #{MGT_CD}
		  AND  bottom_cd = #{BOTTOM_CD}
		  AND  bgt_cd    = #{BGT_CD}
	</update>
	
	<select id="BudgetMaria.getPreBudgetInfo2" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		select fn_getBgtApplyAmt(
		#{divCd}
		, #{pjtCd}
		, #{bgtCd}
		, #{reqMonthFr}
		, #{reqMonthTo}
		) AS applyAm
	</select>
	
	<resultMap type="map" id="doc">
		<result property="V_OUT_C_DIKEYCODE" column="V_OUT_C_DIKEYCODE"/>
		<result property="V_OUT_DOC_NUMBER" column="V_OUT_DOC_NUMBER"/>
		<result property="V_OUT_DOC_TITLE" column="V_OUT_DOC_TITLE"/>
		<result property="V_OUT_DOC_REGDATE" column="V_OUT_DOC_REGDATE"/>
		<result property="V_OUT_YN" column="V_OUT_YN"/>
		<result property="V_OUT_MSG" column="V_OUT_MSG"/>
	</resultMap>
	
	<select id="causeActDocSearch" parameterType="map" resultMap = "doc">

		CALL SP_DOCINFO_SELECT1(
			#{co_cd}, 
			#{gisu_dt}, 
			#{gisu_sq},
			@V_OUT_C_DIKEYCODE,@V_OUT_DOC_NUMBER,@V_OUT_DOC_TITLE,@V_OUT_DOC_REGDATE,@V_OUT_YN,@V_OUT_MSG
		)
		
	</select>
		<select id="causeActDocSearch1" parameterType="map" resultType = "map">

			select
			@V_OUT_C_DIKEYCODE AS V_OUT_C_DIKEYCODE,
			@V_OUT_DOC_NUMBER AS V_OUT_DOC_NUMBER,
			@V_OUT_DOC_TITLE AS V_OUT_DOC_TITLE,
			@V_OUT_DOC_REGDATE AS V_OUT_DOC_REGDATE,
			@V_OUT_YN AS V_OUT_YN,
			@V_OUT_MSG AS V_OUT_MSG

	</select>
	
	<select id="caseActDetailList2" parameterType="map" resultType="map">
		/*BudgetMaria.caseActDetailList2*/
		select
			#{budget_am} as BUDGET_AM,
			'품의서' as `TYPE`,
			'1' as `DIV`,
			DATE_FORMAT(a.erp_gisu_dt ,'%Y-%m-%d') as GISU_DT,
			a.erp_gisu_dt as GISU_DT2,
			a.rmk_dc as RMK_DC,
			a.*,
			b.apply_am as apply_am2,
			c.apply_am as return_am,
		    a.apply_am - ifnull(b.apply_am,0) + ifnull(c.apply_am,0) as WON_AM,
		    DATE_FORMAT(a.erp_gisu_dt ,'%Y-%m') as GW_MONTH
		from
		(select
			h.abdocu_no, h.erp_gisu_dt, h.mgt_cd, h.mgt_nm, h.docu_mode,
		    case
				when h.rmk_dc = '' or h.rmk_dc is null 
		        then 
					case
						when (select rm from dj_bsrp_list where abdocu_no = h.abdocu_no limit 1) is not null
		                then (select rm from dj_bsrp_list where abdocu_no = h.abdocu_no limit 1)
		                when (select pr.purc_req_title from dj_purc_req pr, dj_purc_req_h prh where pr.purc_req_id = prh.purc_req_id and prh.abdocu_no = h.abdocu_no limit 1) is not null
		                then (select pr.purc_req_title from dj_purc_req pr, dj_purc_req_h prh where pr.purc_req_id = prh.purc_req_id and prh.abdocu_no = h.abdocu_no limit 1)
		                else ''
					end
		        else h.rmk_dc
			end as rmk_dc,
			b.abdocu_b_no, b.abgt_cd, b.abgt_nm, b.apply_am
		from neos.g20_abdocu_h h, neos.g20_abdocu_b b, neos.erpgwlink egl
		where h.abdocu_no = b.abdocu_no
		and h.c_dikeycode = egl.appr_dikey
		and b.confer_return is null
		and egl.appr_status in ('002', '003', '008', '009')
		and h.docu_mode = 0) a
		left outer join
		(select 
			max(h.abdocu_no_reffer) as abdocu_no_reffer,
		    max(b.abdocu_b_no_reffer) as abdocu_b_no_reffer,
		    sum(b.apply_am) as apply_am
		from neos.g20_abdocu_h h, neos.g20_abdocu_b b, neos.erpgwlink egl
		where h.abdocu_no = b.abdocu_no
		and h.c_dikeycode = egl.appr_dikey
		and egl.appr_status in ('008', '009')
		and h.docu_mode = 1
		and b.abdocu_b_no_reffer is not null
		group by b.abdocu_b_no_reffer) b
		on a.abdocu_no = b.abdocu_no_reffer
		and a.abdocu_b_no = b.abdocu_b_no_reffer
		left outer join
			neos.g20_abdocu_b c
		on a.abdocu_no = c.abdocu_no
		and a.abdocu_b_no = c.confer_return
		where a.abgt_cd = #{bgt_cd}
		and a.erp_gisu_dt between #{from_standard_period} and #{to_standard_period}
		and a.apply_am - ifnull(b.apply_am,0) + ifnull(c.apply_am,0) > 0
		union
		select
			#{budget_am} as BUDGET_AM,
			'' as `TYPE`,
			'2' as `DIV`,
			'월계' as GISU_DT,
			CONCAT(DATE_FORMAT(a.erp_gisu_dt ,'%Y%m'), '99') as GISU_DT2,
			'' as RMK_DC,
			a.*,
			b.apply_am as apply_am2,
			c.apply_am as return_am,
		    sum(a.apply_am - ifnull(b.apply_am,0) + ifnull(c.apply_am,0)) as WON_AM,
		    DATE_FORMAT(a.erp_gisu_dt ,'%Y-%m') as GW_MONTH
		from
		(select
			h.abdocu_no, h.erp_gisu_dt, h.mgt_cd, h.mgt_nm, h.docu_mode,
		    case
				when h.rmk_dc = '' or h.rmk_dc is null 
		        then 
					case
						when (select rm from dj_bsrp_list where abdocu_no = h.abdocu_no limit 1) is not null
		                then (select rm from dj_bsrp_list where abdocu_no = h.abdocu_no limit 1)
		                when (select pr.purc_req_title from dj_purc_req pr, dj_purc_req_h prh where pr.purc_req_id = prh.purc_req_id and prh.abdocu_no = h.abdocu_no limit 1) is not null
		                then (select pr.purc_req_title from dj_purc_req pr, dj_purc_req_h prh where pr.purc_req_id = prh.purc_req_id and prh.abdocu_no = h.abdocu_no limit 1)
		                else ''
					end
		        else h.rmk_dc
			end as rmk_dc,
			b.abdocu_b_no, b.abgt_cd, b.abgt_nm, b.apply_am
		from neos.g20_abdocu_h h, neos.g20_abdocu_b b, neos.erpgwlink egl
		where h.abdocu_no = b.abdocu_no
		and h.c_dikeycode = egl.appr_dikey
		and b.confer_return is null
		and egl.appr_status in ('002', '003', '008', '009')
		and h.docu_mode = 0) a
		left outer join
		(select 
			max(h.abdocu_no_reffer) as abdocu_no_reffer,
		    max(b.abdocu_b_no_reffer) as abdocu_b_no_reffer,
		    sum(b.apply_am) as apply_am
		from neos.g20_abdocu_h h, neos.g20_abdocu_b b, neos.erpgwlink egl
		where h.abdocu_no = b.abdocu_no
		and h.c_dikeycode = egl.appr_dikey
		and egl.appr_status in ('008', '009')
		and h.docu_mode = 1
		and b.abdocu_b_no_reffer is not null
		group by b.abdocu_b_no_reffer) b
		on a.abdocu_no = b.abdocu_no_reffer
		and a.abdocu_b_no = b.abdocu_b_no_reffer
		left outer join
			neos.g20_abdocu_b c
		on a.abdocu_no = c.abdocu_no
		and a.abdocu_b_no = c.confer_return
		where a.abgt_cd = #{bgt_cd}
		and a.erp_gisu_dt between #{from_standard_period} and #{to_standard_period}
		and a.apply_am - ifnull(b.apply_am,0) + ifnull(c.apply_am,0) > 0
		group by GW_MONTH
		order by GISU_DT2
	</select>
	
	<select id="BudgetMaria.getDocInfo"  parameterType="map" statementType="CALLABLE">
		CALL cust_epis.SP_DOCINFO_SELECT1(#{CO_CD}, #{ISU_DT},#{ISU_SQ}, #{C_DIKEYCODE, mode=OUT, jdbcType=VARCHAR}, #{DOC_NUMBER, mode=OUT, jdbcType=VARCHAR},#{DOC_TITLE, mode=OUT, jdbcType=VARCHAR}, #{DOC_REGDATE, mode=OUT, jdbcType=VARCHAR},#{OUT_YN, mode=OUT, jdbcType=VARCHAR}, #{OUT_MSG, mode=OUT, jdbcType=VARCHAR})
	</select>
	
	<select id="BudgetMaria.getOneErpEmpNum" parameterType="map" resultType="String">
		select MAX(B.erp_emp_num) from neos.t_co_emp_dept A
		inner join NEOS.T_CO_EMP B
        on A.emp_seq = B.emp_seq
		where A.dept_seq = #{deptSeq} 
		and A.use_yn = 'Y'
        and B.use_yn = 'Y'
	</select>
	
	<select id="BudgetMaria.amountGoodsList"  parameterType="map" statementType="CALLABLE">
		CALL cust_epis.SP_GET_BGT_APPLY_AMT(#{DIV_CD}, #{PJT_CD_FR}, #{PJT_CD_TO}, #{BGT_CD}, #{FROM_MONTH}, #{MONTH}, #{APPLY_AMT, mode=OUT, jdbcType=VARCHAR}, #{OUT_YN, mode=OUT, jdbcType=VARCHAR},#{OUT_MSG, mode=OUT, jdbcType=VARCHAR})
	</select>	
	
	<select id="BudgetMaria.getResDocSubmitList" parameterType="map" resultType="map">
		/*BudgetMaria.getResDocSubmitList*/
		SELECT	
			d.res_doc_seq	AS 'consDocSeq'
			, d.doc_seq	AS 'docSeq'
			, d.doc_seq		AS 'docSeq'
			, IFNULL(r.c_ridocfullnum, '')	AS 'docNo'
			, d.doc_status		AS 'docStatus'
<!-- 			, i.c_diwriteday	AS 'docDate' -->
			, date_format(gwlink.appr_end_date, '%Y-%m-%d')	AS 'docDate'
			, d.resdoc_note	AS 'consdocNote'			
			, d.resdoc_note	AS 'resdocNote'
			, d.expend_date	AS 'expendDate'
			, d.comp_name	AS 'compName'
			, d.dept_name	AS 'deptName'	
			, d.emp_name	AS 'empName'
			, d.send_emp_seq	AS 'sendEmpSeq'
			, d.send_date		AS 'sendDate'
			, d.send_emp_name	AS 'sendName'			
			, r.c_riaftertitle	AS 'docTitle'
			, amt.resDocAmt		AS 'resDocAmt'
			, amt.resDocTaxAmt	AS 'resDocTaxAmt'
			, amt.resDocStdAmt	AS 'resDocStdAmt'	
			, d.erp_send_yn	AS 'erpSendYN'		
			, 'EA'			AS 'eaType'
			, IFNULL(ds.submit_yn, 'N') AS 'submitYn'
			, concat(date_format(ds.reg_date, '%Y-%m-%d'), '-', lpad(ds.reg_no, 4, '0')) AS 'regNo'
			, ds.return_yn AS 'returnYn'
			, ds.return_reason AS 'returnReason'
			, ds.return_date AS 'returnDate'
			, gwlink.docx_numb AS 'docxNumb'
		FROM	neos.t_exnp_resdoc	d
		INNER JOIN	neos.a_recordinfo	r
		 ON	d.doc_seq = r.c_dikeycode
		INNER JOIN	(
			SELECT	c_dikeycode,  MIN(c_diwriteday) AS c_diwriteday
			FROM	neos.a_draftinfo 
			WHERE	IFNULL(c_distatus, '008') != 'd'
			GROUP BY c_dikeycode 
		)	i
		 ON	r.c_dikeycode = i.c_dikeycode
 		INNER JOIN	(
			SELECT	
				res_doc_seq
				, SUM(IFNULL(budget_amt, 0)) AS resDocAmt
				, SUM(IFNULL(budget_tax_amt, 0)) AS resDocTaxAmt
				, SUM(IFNULL(budget_std_amt, 0)) AS resDocStdAmt
			FROM	neos.t_exnp_resbudget 
			GROUP BY res_doc_seq		
		)	amt		
		ON	d.res_doc_seq = amt.res_doc_seq	
		INNER JOIN neos.erpgwlink gwlink
        ON			gwlink.appr_dikey = d.doc_seq
        LEFT JOIN res_doc_submit ds
        ON d.res_doc_seq = ds.resDocSeq	
		WHERE	d.comp_seq = #{compSeq}
		<choose>
			<when test='empSeq != null and empSeq != ""'>
		 AND	d.emp_seq = #{empSeq}
		 	</when>
			<when test='deptSeq != null and deptSeq != ""'>
		 AND	d.dept_seq = #{deptSeq}
		 	</when>
		</choose>
		 AND	d.doc_seq IS NOT NULL
		 AND 	IFNULL(doc_status, '008') IN ( '001', '002', '003', '004','007', '008', '009','20', '30', '90' )
		 AND	doc_status in ('008', '009', '90')
		 AND	LEFT(requ_date,8) BETWEEN #{frDt} AND #{toDt}
		<if test="docTitle != null">
		 AND	c_riaftertitle LIKE CONCAT('%', IFNULL(#{docTitle}, ''), '%')
		</if>
		<if test="docNo != null">
		 AND	c_ridocfullnum LIKE CONCAT('%', IFNULL(#{docNo}, ''), '%')
		</if>
		<if test='submitYn != null and submitYn != ""'>
		 AND	IFNULL(ds.submit_yn, 'N') = #{submitYn}
		</if>
		<choose>
			<when test='order != null and order != ""'>
		ORDER BY ${order}
			</when>
			<otherwise>
		ORDER BY expend_date DESC
			</otherwise>
		</choose>
	</select>
	
	<insert id="BudgetMaria.resDocSubmit" parameterType="map">
		/*BudgetMaria.resDocSubmit*/
		INSERT INTO res_doc_submit
			(resDocSeq, submit_yn, submit_emp, submit_date, reg_date, reg_no, submit_type, deadline)
		VALUES
			(#{resDocSeq}, 'Y', #{empSeq}, now(), date_format(now(), '%Y%m%d'), (SELECT ifnull(max(ds.reg_no),0) + 1 FROM res_doc_submit as ds where ds.reg_date = date_format(now(), '%Y%m%d')), #{submitType}, #{deadline})
		ON DUPLICATE KEY
		UPDATE	submit_yn = 'Y',
				submit_emp = #{empSeq},
				submit_date = now(),
				submit_type = #{submitType},
				deadline = #{deadline}
	</insert>

	<update id="BudgetMaria.resDocUpdate">
		/*BudgetMaria.resDocUpdate*/
		UPDATE res_doc_submit
		SET submit_type = '1',
			deadline = #{deadline}
		WHERE resDocSeq = #{resDocSeq}
	</update>
	
	<update id="BudgetMaria.updateUseYn">
		/*BudgetMaria.updateUseYn*/
		UPDATE res_doc_submit
		SET use_yn = #{useYn}
		WHERE resDocSeq = #{resDocSeq}
	</update>
	
	<select id="BudgetMaria.getResDocSubmitAdminList" parameterType="map" resultType="map">
		/*BudgetMaria.getResDocSubmitAdminList*/
		SELECT	
			d.res_doc_seq	AS 'consDocSeq'
			, d.doc_seq	AS 'docSeq'
			, d.doc_seq		AS 'docSeq'
			, IFNULL(r.c_ridocfullnum, '')	AS 'docNo'
			, d.doc_status		AS 'docStatus'
<!-- 			, i.c_diwriteday	AS 'docDate' -->
			, date_format(gwlink.appr_end_date, '%Y-%m-%d')	AS 'docDate'
			, d.resdoc_note	AS 'consdocNote'			
			, d.resdoc_note	AS 'resdocNote'
			, d.expend_date	AS 'expendDate'
			, d.comp_name	AS 'compName'
			, d.dept_name	AS 'deptName'	
			, d.emp_name	AS 'empName'
			, d.send_emp_seq	AS 'sendEmpSeq'
			, d.send_date		AS 'sendDate'
			, d.send_emp_name	AS 'sendName'			
			, r.c_riaftertitle	AS 'docTitle'
			, d.erp_send_yn	AS 'erpSendYN'		
			, 'EA'			AS 'eaType'
			, IFNULL(ds.submit_yn, 'N') AS 'submitYn'
			, concat(date_format(ds.reg_date, '%Y-%m-%d'), '-', lpad(ds.reg_no, 4, '0')) AS 'regNo'
			, h.mgt_name AS 'mgtName'
			, h.erp_comp_seq AS 'erpCompSeq'
			, IFNULL(amt.budget_amt, 0) AS 'resDocAmt'
			, IFNULL(amt.budget_tax_amt, 0) AS 'resDocTaxAmt'
			, IFNULL(amt.budget_std_amt, 0) AS 'resDocStdAmt'
			, amt.erp_budget_name AS 'repBudgetName'
			, amt.erp_gisu_date AS 'erpGisuDate'
			, amt.erp_gisu_sq AS 'erpGisuSq'
			, amt.erp_bg_sq AS 'erpBgSq'
			, ds.use_yn AS 'useYn'
			, case when ds.use_yn = 'N' then '처리제외' else '미확정' end AS 'useName'
			, ds.deadline AS 'deadline'
		FROM	neos.t_exnp_resdoc	d
		INNER JOIN neos.t_exnp_reshead h
		 ON d.res_doc_seq = h.res_doc_seq
		INNER JOIN	neos.a_recordinfo	r
		 ON	d.doc_seq = r.c_dikeycode
		INNER JOIN	(
			SELECT	c_dikeycode,  MIN(c_diwriteday) AS c_diwriteday
			FROM	neos.a_draftinfo 
			WHERE	IFNULL(c_distatus, '008') != 'd'
			GROUP BY c_dikeycode 
		)	i
		 ON	r.c_dikeycode = i.c_dikeycode
 		INNER JOIN neos.t_exnp_resbudget amt		
		ON	h.res_seq = amt.res_seq	
		and h.res_doc_seq = amt.res_doc_seq
		INNER JOIN neos.erpgwlink gwlink
        ON			gwlink.appr_dikey = d.doc_seq
        LEFT JOIN cust_epis.res_doc_submit ds
        ON d.res_doc_seq = ds.resDocSeq	
		WHERE	d.comp_seq = #{compSeq}
		<choose>
			<when test='empSeq != null and empSeq != ""'>
		 AND	d.emp_seq = #{empSeq}
		 	</when>
			<when test='deptSeq != null and deptSeq != ""'>
		 AND	d.dept_seq = #{deptSeq}
		 	</when>
		</choose>
		 AND	d.doc_seq IS NOT NULL
		 AND 	IFNULL(doc_status, '008') IN ( '001', '002', '003', '004','007', '008', '009','20', '30', '90' )
		 AND	doc_status in ('008', '009', '90')
		 AND	LEFT(requ_date,8) BETWEEN #{frDt} AND #{toDt}
		<if test="docTitle != null">
		 AND	c_riaftertitle LIKE CONCAT('%', IFNULL(#{docTitle}, ''), '%')
		</if>
		<if test="docNo != null">
		 AND	c_ridocfullnum LIKE CONCAT('%', IFNULL(#{docNo}, ''), '%')
		</if>
		<if test='submitYn != null and submitYn != ""'>
		 AND	IFNULL(ds.submit_yn, 'N') = #{submitYn}
		</if>
		<if test='biddingYn != null and biddingYn == "D"'>
		 AND	ds.use_yn = 'N'
		</if>
		<if test='biddingYn != null and biddingYn == "N"'>
		 AND	ds.use_yn = 'Y'
		</if>
		<if test='submitType != null and submitType != ""'>
		 AND	ds.submit_type = #{submitType}
		</if>
		<if test='returnYn != null and returnYn != ""'>
		 AND	ds.return_yn = #{returnYn}
		</if>
		<choose>
			<when test='order != null and order != ""'>
		ORDER BY ${order}
			</when>
			<otherwise>
		ORDER BY expend_date DESC
			</otherwise>
		</choose>

		LIMIT ${st}, ${end}
	</select>

	<select id="BudgetMaria.getResDocSubmitAdminListCnt" parameterType="map" resultType="int">
		/*BudgetMaria.getResDocSubmitAdminListCnt*/
		SELECT
			count(*)
		FROM	neos.t_exnp_resdoc	d
		INNER JOIN neos.t_exnp_reshead h
		ON d.res_doc_seq = h.res_doc_seq
		INNER JOIN	neos.a_recordinfo	r
		ON	d.doc_seq = r.c_dikeycode
		INNER JOIN	(
		SELECT	c_dikeycode,  MIN(c_diwriteday) AS c_diwriteday
		FROM	neos.a_draftinfo
		WHERE	IFNULL(c_distatus, '008') != 'd'
		GROUP BY c_dikeycode
		)	i
		ON	r.c_dikeycode = i.c_dikeycode
		INNER JOIN neos.t_exnp_resbudget amt
		ON	h.res_seq = amt.res_seq
		and h.res_doc_seq = amt.res_doc_seq
		INNER JOIN neos.erpgwlink gwlink
		ON			gwlink.appr_dikey = d.doc_seq
		LEFT JOIN cust_epis.res_doc_submit ds
		ON d.res_doc_seq = ds.resDocSeq
		WHERE	d.comp_seq = #{compSeq}
		<choose>
			<when test='empSeq != null and empSeq != ""'>
				AND	d.emp_seq = #{empSeq}
			</when>
			<when test='deptSeq != null and deptSeq != ""'>
				AND	d.dept_seq = #{deptSeq}
			</when>
		</choose>
		AND	d.doc_seq IS NOT NULL
		AND 	IFNULL(doc_status, '008') IN ( '001', '002', '003', '004','007', '008', '009','20', '30', '90' )
		AND	doc_status in ('008', '009', '90')
		AND	LEFT(requ_date,8) BETWEEN #{frDt} AND #{toDt}
		<if test="docTitle != null">
			AND	c_riaftertitle LIKE CONCAT('%', IFNULL(#{docTitle}, ''), '%')
		</if>
		<if test="docNo != null">
			AND	c_ridocfullnum LIKE CONCAT('%', IFNULL(#{docNo}, ''), '%')
		</if>
		<if test='submitYn != null and submitYn != ""'>
			AND	IFNULL(ds.submit_yn, 'N') = #{submitYn}
		</if>
		<if test='biddingYn != null and biddingYn == "D"'>
			AND	ds.use_yn = 'N'
		</if>
		<if test='biddingYn != null and biddingYn == "N"'>
			AND	ds.use_yn = 'Y'
		</if>
		<if test='submitType != null and submitType != ""'>
			AND	ds.submit_type = #{submitType}
		</if>
		<if test='returnYn != null and returnYn != ""'>
			AND	ds.return_yn = #{returnYn}
		</if>
		<choose>
			<when test='order != null and order != ""'>
				ORDER BY ${order}
			</when>
			<otherwise>
				ORDER BY expend_date DESC
			</otherwise>
		</choose>
	</select>

	<select id="BudgetMaria.getResDocInfo" parameterType="map" resultType="map">
		/*BudgetMaria.getResDocInfo*/
		select doc_seq as doc_seq
		from neos.t_exnp_resDoc a, neos.t_exnp_reshead b
		where a.res_doc_seq = b.res_doc_seq
		and b.erp_gisu_date = #{gisu_dt}
		and b.erp_gisu_sq = #{gisu_sq}
		limit 1
	</select>
	
	<select id="BudgetMaria.getResDocFile" parameterType="map" resultType="map">
		/*BudgetMaria.getResDocFile*/
		select a.*
			, (select c_ridocfullnum from neos.a_recordinfo where c_dikeycode = a.rep_id limit 1) as docNum
			, (select c_ridocfullnum from neos.a_recordinfo where c_dikeycode = a.rep_id limit 1) as docNum
		from c_pdf_duzon_appdoc a
		where a.rep_id = #{doc_seq}
	</select>
	
	<select id="BudgetMaria.getAdocuDocInfo" parameterType="map" resultType="map">
		/*BudgetMaria.getAdocuDocInfo*/
		select b.c_distatus, c.c_ridocfullnum , a.appr_dikey
			, (SELECT detail_name FROM neos.t_co_code_detail_multi where code = 'COM109' and lang_code = 'kr' and detail_code = b.c_distatus) as c_distatus_nm
			, (select emp_name from neos.v_user_info where emp_seq = b.c_dilastuserkey limit 1) as kyuljaeuser
		from neos.erpgwlink a, neos.a_draftinfo b, neos.a_recordinfo c
		where a.appr_dikey = b.c_dikeycode
		and a.appr_dikey = c.c_dikeycode
		and a.docx_numb = concat('DJADOCUEA_', #{ISU_DT}, '_', #{ISU_SQ})
		limit 1
	</select>

	<select id="BudgetMaria.getAdocuDocInfo2" parameterType="map" resultType="map">
		/*BudgetMaria.getAdocuDocInfo2*/
		select b.c_distatus, c.c_ridocfullnum , a.appr_dikey
			, (SELECT detail_name FROM neos.t_co_code_detail_multi where code = 'COM109' and lang_code = 'kr' and detail_code = b.c_distatus) as c_distatus_nm
			, (select emp_name from neos.v_user_info where emp_seq = b.c_dilastuserkey limit 1) as kyuljaeuser
		from neos.erpgwlink a, neos.a_draftinfo b, neos.a_recordinfo c
		where a.appr_dikey = b.c_dikeycode
		and a.appr_dikey = c.c_dikeycode
		and b.c_dikeycode = #{doc_id}
	</select>

	<select id="BudgetMaria.getAdocuDocInfoList" parameterType="map" resultType="map">
		/*BudgetMaria.getAdocuDocInfoList*/
		select b.c_distatus, c.c_ridocfullnum , a.appr_dikey
			, (SELECT detail_name FROM neos.t_co_code_detail_multi where code = 'COM109' and lang_code = 'kr' and detail_code = b.c_distatus) as c_distatus_nm
			, (select emp_name from neos.v_user_info where emp_seq = b.c_dilastuserkey limit 1) as kyuljaeuser
		from neos.erpgwlink a, neos.a_draftinfo b, neos.a_recordinfo c
		where a.appr_dikey = b.c_dikeycode
		and a.appr_dikey = c.c_dikeycode
		and a.docx_numb = concat('DJADOCUEA_', #{ISU_DT}, '_', #{ISU_SQ})
	</select>
	
	<insert id="BudgetMaria.insertBudgetAttach" parameterType="map">
		INSERT INTO cust_epis.dj_budget_attach 
			(
				target_id
				,file_seq
				,file_name
				,real_file_name
				,file_extension
				,file_path
				,file_size
				,use_yn
			) VALUES
			(
				#{targetId}
				,#{fileSeq}
				,#{orgFileName}
				,#{realFileName}
				,#{ext}
				,#{filePath}
				,#{fileSize}
				,'Y'
			)
	</insert>
	
	<select id="BudgetMaria.getBudgetAttach" resultType="map" parameterType="map">
		SELECT * FROM cust_epis.dj_budget_attach
						WHERE target_id = #{targetId} and use_yn = 'Y'
	</select>
	
	<select id="BudgetMaria.getBudgetAttachOne" resultType="map" parameterType="map">
		SELECT * FROM cust_epis.dj_budget_attach
						WHERE target_id = #{targetId} and use_yn = 'Y' and file_seq = #{fileSeq}
	</select>
	
	<select id="BudgetMaria.getErpGwLinkInfo" resultType="map" parameterType="map">
		select 
			IFNULL(appr_seqn, '') as appr_seqn
		    ,IFNULL(docx_numb, '') as docx_numb
		    ,requ_date
		    ,IFNULL(appr_dikey, '') as appr_dikey
		    ,c_dititle
		    ,appr_status
		    ,detail_name AS statusNm
		    ,emp_name
		from neos.erpgwlink A
		inner join neos.a_docinfo B
				on A.appr_dikey = B.c_dikeycode
		inner join neos.t_co_code_detail_multi C
				on A.appr_status = C.detail_code
		inner join neos.t_co_emp_multi D
				on B.create_seq = D.emp_seq				
			WHERE A.docx_numb like CONCAT('%', #{approKey}, '%') and C.code = 'COM109' and C.lang_code = 'kr' and D.lang_code = 'kr'
			order by A.appr_seqn desc limit 1
	</select>
	
	<select id="BudgetMaria.getDailyScheduleStatus" resultType="String" parameterType="map">
		SELECT count(*) FROM cust_epis.dj_budget_dailyschedule
				WHERE appr_dikey = #{appr_dikey}
	</select>
	
	<insert id="BudgetMaria.saveDailyScheduleStatus" parameterType="map">
		INSERT INTO cust_epis.dj_budget_dailyschedule
			(appr_dikey, status, create_date)
		VALUES
			(#{appr_dikey}, 'C', now())	
	</insert>
	
	<update id="BudgetMaria.updateFile" parameterType="map">
		UPDATE cust_epis.dj_budget_attach 
				SET use_yn = 'N'
				WHERE target_id = #{targetId} and file_seq = #{fileSeq} and real_file_name = #{realFileName}
	</update>
	
	<select id="BudgetMaria.selectMaxFileSeq" parameterType="map" resultType="String">
		SELECT IFNULL(MAX(file_seq), 0) as maxSeq
			FROM  cust_epis.dj_budget_attach
		WHERE target_id = #{orderSq} and use_yn = 'Y'
	</select>
	
	<select id="BudgetMaria.updateReturn" parameterType="map">
		/*BudgetMaria.updateReturn*/
		UPDATE res_doc_submit
		SET	return_yn = 'Y',
			return_reason = #{returnReason},
			return_date = now()
		WHERE resDocSeq = #{resDocSeq}
	</select>
	
	<select id="BudgetMaria.getAskedEmpNm" parameterType="String" resultType="String">
		select emp_name 
		from neos.t_co_emp_multi 
		where emp_seq = #{modifyId}
	</select>

	<select id="BudgetMaria.getResDocBizFeeList" parameterType="map" resultType="map">
		/*BudgetMaria.getResDocBizFeeList*/
		SELECT
		d.res_doc_seq	AS 'consDocSeq'
		, d.doc_seq	AS 'docSeq'
		, d.doc_seq		AS 'docSeq'
		, IFNULL(r.c_ridocfullnum, '')	AS 'docNo'
		, d.doc_status		AS 'docStatus'
		<!-- 			, i.c_diwriteday	AS 'docDate' -->
		, date_format(gwlink.appr_end_date, '%Y-%m-%d')	AS 'docDate'
		, d.resdoc_note	AS 'consdocNote'
		, d.resdoc_note	AS 'resdocNote'
		, d.expend_date	AS 'expendDate'
		, d.comp_name	AS 'compName'
		, d.dept_name	AS 'deptName'
		, d.emp_name	AS 'empName'
		, d.send_emp_seq	AS 'sendEmpSeq'
		, d.send_date		AS 'sendDate'
		, d.send_emp_name	AS 'sendName'
		, r.c_riaftertitle	AS 'docTitle'
		, d.erp_send_yn	AS 'erpSendYN'
		, 'EA'			AS 'eaType'
		, IFNULL(ds.submit_yn, 'N') AS 'submitYn'
		, concat(date_format(ds.reg_date, '%Y-%m-%d'), '-', lpad(ds.reg_no, 4, '0')) AS 'regNo'
		, h.mgt_name AS 'mgtName'
		, h.erp_comp_seq AS 'erpCompSeq'
		, IFNULL(amt.budget_amt, 0) AS 'resDocAmt'
		, IFNULL(amt.budget_tax_amt, 0) AS 'resDocTaxAmt'
		, IFNULL(amt.budget_std_amt, 0) AS 'resDocStdAmt'
		, amt.erp_budget_name AS 'repBudgetName'
		, amt.erp_gisu_date AS 'erpGisuDate'
		, amt.erp_gisu_sq AS 'erpGisuSq'
		, amt.erp_bg_sq AS 'erpBgSq'
		, ds.use_yn AS 'useYn'
		, case when ds.use_yn = 'N' then '처리제외' else '미확정' end AS 'useName'
		, ds.deadline AS 'deadline'
		FROM	neos.t_exnp_resdoc	d
		INNER JOIN neos.t_exnp_reshead h
		ON d.res_doc_seq = h.res_doc_seq
		INNER JOIN	neos.a_recordinfo	r
		ON	d.doc_seq = r.c_dikeycode
		INNER JOIN	(
		SELECT	c_dikeycode,  MIN(c_diwriteday) AS c_diwriteday
		FROM	neos.a_draftinfo
		WHERE	IFNULL(c_distatus, '008') != 'd'
		GROUP BY c_dikeycode
		)	i
		ON	r.c_dikeycode = i.c_dikeycode
		INNER JOIN neos.t_exnp_resbudget amt
		ON	h.res_seq = amt.res_seq
		and h.res_doc_seq = amt.res_doc_seq
		INNER JOIN neos.erpgwlink gwlink
		ON			gwlink.appr_dikey = d.doc_seq
		LEFT JOIN cust_epis.res_doc_submit ds
		ON d.res_doc_seq = ds.resDocSeq
		WHERE	d.comp_seq = #{compSeq}
		<choose>
			<when test='empSeq != null and empSeq != ""'>
				AND	d.emp_seq = #{empSeq}
			</when>
			<when test='deptSeq != null and deptSeq != ""'>
				AND	d.dept_seq = #{deptSeq}
			</when>
		</choose>
		AND	d.doc_seq IS NOT NULL
		AND 	IFNULL(doc_status, '008') IN ( '001', '002', '003', '004','007', '008', '009','20', '30', '90' )
		AND	doc_status in ('008', '009', '90')
		AND	LEFT(requ_date,8) BETWEEN #{frDt} AND #{toDt}
		AND d.OUT_PROCESS_INTERFACE_ID = 'dj_bizFee'
		<if test="docTitle != null">
			AND	c_riaftertitle LIKE CONCAT('%', IFNULL(#{docTitle}, ''), '%')
		</if>
		<if test="docNo != null">
			AND	c_ridocfullnum LIKE CONCAT('%', IFNULL(#{docNo}, ''), '%')
		</if>
		<if test='submitYn != null and submitYn != ""'>
			AND	IFNULL(ds.submit_yn, 'N') = #{submitYn}
		</if>
		<if test='biddingYn != null and biddingYn == "D"'>
			AND	ds.use_yn = 'N'
		</if>
		<if test='biddingYn != null and biddingYn == "N"'>
			AND	ds.use_yn = 'Y'
		</if>
		<if test='submitType != null and submitType != ""'>
			AND	ds.submit_type = #{submitType}
		</if>
		<if test='returnYn != null and returnYn != ""'>
			AND	ds.return_yn = #{returnYn}
		</if>
		<choose>
			<when test='order != null and order != ""'>
				ORDER BY ${order}
			</when>
			<otherwise>
				ORDER BY expend_date DESC
			</otherwise>
		</choose>

		LIMIT ${st}, ${end}
	</select>

	<select id="BudgetMaria.getResDocBizFeeListCnt" parameterType="map" resultType="int">
		/*BudgetMaria.getResDocBizFeeListCnt*/
		SELECT
		count(*)
		FROM	neos.t_exnp_resdoc	d
		INNER JOIN neos.t_exnp_reshead h
		ON d.res_doc_seq = h.res_doc_seq
		INNER JOIN	neos.a_recordinfo	r
		ON	d.doc_seq = r.c_dikeycode
		INNER JOIN	(
		SELECT	c_dikeycode,  MIN(c_diwriteday) AS c_diwriteday
		FROM	neos.a_draftinfo
		WHERE	IFNULL(c_distatus, '008') != 'd'
		GROUP BY c_dikeycode
		)	i
		ON	r.c_dikeycode = i.c_dikeycode
		INNER JOIN neos.t_exnp_resbudget amt
		ON	h.res_seq = amt.res_seq
		and h.res_doc_seq = amt.res_doc_seq
		INNER JOIN neos.erpgwlink gwlink
		ON			gwlink.appr_dikey = d.doc_seq
		LEFT JOIN cust_epis.res_doc_submit ds
		ON d.res_doc_seq = ds.resDocSeq
		WHERE	d.comp_seq = #{compSeq}
		<choose>
			<when test='empSeq != null and empSeq != ""'>
				AND	d.emp_seq = #{empSeq}
			</when>
			<when test='deptSeq != null and deptSeq != ""'>
				AND	d.dept_seq = #{deptSeq}
			</when>
		</choose>
		AND	d.doc_seq IS NOT NULL
		AND 	IFNULL(doc_status, '008') IN ( '001', '002', '003', '004','007', '008', '009','20', '30', '90' )
		AND	doc_status in ('008', '009', '90')
		AND	LEFT(requ_date,8) BETWEEN #{frDt} AND #{toDt}
		AND d.OUT_PROCESS_INTERFACE_ID = 'dj_bizFee'
		<if test="docTitle != null">
			AND	c_riaftertitle LIKE CONCAT('%', IFNULL(#{docTitle}, ''), '%')
		</if>
		<if test="docNo != null">
			AND	c_ridocfullnum LIKE CONCAT('%', IFNULL(#{docNo}, ''), '%')
		</if>
		<if test='submitYn != null and submitYn != ""'>
			AND	IFNULL(ds.submit_yn, 'N') = #{submitYn}
		</if>
		<if test='biddingYn != null and biddingYn == "D"'>
			AND	ds.use_yn = 'N'
		</if>
		<if test='biddingYn != null and biddingYn == "N"'>
			AND	ds.use_yn = 'Y'
		</if>
		<if test='submitType != null and submitType != ""'>
			AND	ds.submit_type = #{submitType}
		</if>
		<if test='returnYn != null and returnYn != ""'>
			AND	ds.return_yn = #{returnYn}
		</if>
		<choose>
			<when test='order != null and order != ""'>
				ORDER BY ${order}
			</when>
			<otherwise>
				ORDER BY expend_date DESC
			</otherwise>
		</choose>
	</select>

	<select id="BudgetMaria.getResDocDailyExpList" parameterType="map" resultType="map">
		/*BudgetMaria.getResDocDailyExpList*/
		SELECT
		d.res_doc_seq	AS 'consDocSeq'
		, d.doc_seq	AS 'docSeq'
		, d.doc_seq		AS 'docSeq'
		, IFNULL(r.c_ridocfullnum, '')	AS 'docNo'
		, d.doc_status		AS 'docStatus'
		<!-- 			, i.c_diwriteday	AS 'docDate' -->
		, date_format(gwlink.appr_end_date, '%Y-%m-%d')	AS 'docDate'
		, d.resdoc_note	AS 'consdocNote'
		, d.resdoc_note	AS 'resdocNote'
		, d.expend_date	AS 'expendDate'
		, d.comp_name	AS 'compName'
		, d.dept_name	AS 'deptName'
		, d.emp_name	AS 'empName'
		, d.send_emp_seq	AS 'sendEmpSeq'
		, d.send_date		AS 'sendDate'
		, d.send_emp_name	AS 'sendName'
		, r.c_riaftertitle	AS 'docTitle'
		, d.erp_send_yn	AS 'erpSendYN'
		, 'EA'			AS 'eaType'
		, IFNULL(ds.submit_yn, 'N') AS 'submitYn'
		, concat(date_format(ds.reg_date, '%Y-%m-%d'), '-', lpad(ds.reg_no, 4, '0')) AS 'regNo'
		, h.mgt_name AS 'mgtName'
		, h.erp_comp_seq AS 'erpCompSeq'
		, IFNULL(amt.budget_amt, 0) AS 'resDocAmt'
		, IFNULL(amt.budget_tax_amt, 0) AS 'resDocTaxAmt'
		, IFNULL(amt.budget_std_amt, 0) AS 'resDocStdAmt'
		, amt.erp_budget_name AS 'repBudgetName'
		, amt.erp_gisu_date AS 'erpGisuDate'
		, amt.erp_gisu_sq AS 'erpGisuSq'
		, amt.erp_bg_sq AS 'erpBgSq'
		, ds.use_yn AS 'useYn'
		, case when ds.use_yn = 'N' then '처리제외' else '미확정' end AS 'useName'
		, ds.deadline AS 'deadline'
		FROM	neos.t_exnp_resdoc	d
		INNER JOIN neos.t_exnp_reshead h
		ON d.res_doc_seq = h.res_doc_seq
		INNER JOIN	neos.a_recordinfo	r
		ON	d.doc_seq = r.c_dikeycode
		INNER JOIN	(
		SELECT	c_dikeycode,  MIN(c_diwriteday) AS c_diwriteday
		FROM	neos.a_draftinfo
		WHERE	IFNULL(c_distatus, '008') != 'd'
		GROUP BY c_dikeycode
		)	i
		ON	r.c_dikeycode = i.c_dikeycode
		INNER JOIN neos.t_exnp_resbudget amt
		ON	h.res_seq = amt.res_seq
		and h.res_doc_seq = amt.res_doc_seq
		INNER JOIN neos.erpgwlink gwlink
		ON			gwlink.appr_dikey = d.doc_seq
		LEFT JOIN cust_epis.res_doc_submit ds
		ON d.res_doc_seq = ds.resDocSeq
		WHERE	d.comp_seq = #{compSeq}
		<choose>
			<when test='empSeq != null and empSeq != ""'>
				AND	d.emp_seq = #{empSeq}
			</when>
			<when test='deptSeq != null and deptSeq != ""'>
				AND	d.dept_seq = #{deptSeq}
			</when>
		</choose>
		AND	d.doc_seq IS NOT NULL
		AND 	IFNULL(doc_status, '008') IN ( '001', '002', '003', '004','007', '008', '009','20', '30', '90' )
		AND	doc_status in ('008', '009', '90')
		AND	LEFT(requ_date,8) BETWEEN #{frDt} AND #{toDt}
		AND d.OUT_PROCESS_INTERFACE_ID = 'dj_dailyExp'
		<if test="docTitle != null">
			AND	c_riaftertitle LIKE CONCAT('%', IFNULL(#{docTitle}, ''), '%')
		</if>
		<if test="docNo != null">
			AND	c_ridocfullnum LIKE CONCAT('%', IFNULL(#{docNo}, ''), '%')
		</if>
		<if test='submitYn != null and submitYn != ""'>
			AND	IFNULL(ds.submit_yn, 'N') = #{submitYn}
		</if>
		<if test='biddingYn != null and biddingYn == "D"'>
			AND	ds.use_yn = 'N'
		</if>
		<if test='biddingYn != null and biddingYn == "N"'>
			AND	ds.use_yn = 'Y'
		</if>
		<if test='submitType != null and submitType != ""'>
			AND	ds.submit_type = #{submitType}
		</if>
		<if test='returnYn != null and returnYn != ""'>
			AND	ds.return_yn = #{returnYn}
		</if>
		<choose>
			<when test='order != null and order != ""'>
				ORDER BY ${order}
			</when>
			<otherwise>
				ORDER BY expend_date DESC
			</otherwise>
		</choose>

		LIMIT ${st}, ${end}
	</select>

	<select id="BudgetMaria.getResDocDailyExpListCnt" parameterType="map" resultType="int">
		/*BudgetMaria.getResDocDailyExpListCnt*/
		SELECT
		count(*)
		FROM	neos.t_exnp_resdoc	d
		INNER JOIN neos.t_exnp_reshead h
		ON d.res_doc_seq = h.res_doc_seq
		INNER JOIN	neos.a_recordinfo	r
		ON	d.doc_seq = r.c_dikeycode
		INNER JOIN	(
		SELECT	c_dikeycode,  MIN(c_diwriteday) AS c_diwriteday
		FROM	neos.a_draftinfo
		WHERE	IFNULL(c_distatus, '008') != 'd'
		GROUP BY c_dikeycode
		)	i
		ON	r.c_dikeycode = i.c_dikeycode
		INNER JOIN neos.t_exnp_resbudget amt
		ON	h.res_seq = amt.res_seq
		and h.res_doc_seq = amt.res_doc_seq
		INNER JOIN neos.erpgwlink gwlink
		ON			gwlink.appr_dikey = d.doc_seq
		LEFT JOIN cust_epis.res_doc_submit ds
		ON d.res_doc_seq = ds.resDocSeq
		WHERE	d.comp_seq = #{compSeq}
		<choose>
			<when test='empSeq != null and empSeq != ""'>
				AND	d.emp_seq = #{empSeq}
			</when>
			<when test='deptSeq != null and deptSeq != ""'>
				AND	d.dept_seq = #{deptSeq}
			</when>
		</choose>
		AND	d.doc_seq IS NOT NULL
		AND 	IFNULL(doc_status, '008') IN ( '001', '002', '003', '004','007', '008', '009','20', '30', '90' )
		AND	doc_status in ('008', '009', '90')
		AND	LEFT(requ_date,8) BETWEEN #{frDt} AND #{toDt}
		AND d.OUT_PROCESS_INTERFACE_ID = 'dj_dailyExp'
		<if test="docTitle != null">
			AND	c_riaftertitle LIKE CONCAT('%', IFNULL(#{docTitle}, ''), '%')
		</if>
		<if test="docNo != null">
			AND	c_ridocfullnum LIKE CONCAT('%', IFNULL(#{docNo}, ''), '%')
		</if>
		<if test='submitYn != null and submitYn != ""'>
			AND	IFNULL(ds.submit_yn, 'N') = #{submitYn}
		</if>
		<if test='biddingYn != null and biddingYn == "D"'>
			AND	ds.use_yn = 'N'
		</if>
		<if test='biddingYn != null and biddingYn == "N"'>
			AND	ds.use_yn = 'Y'
		</if>
		<if test='submitType != null and submitType != ""'>
			AND	ds.submit_type = #{submitType}
		</if>
		<if test='returnYn != null and returnYn != ""'>
			AND	ds.return_yn = #{returnYn}
		</if>
		<choose>
			<when test='order != null and order != ""'>
				ORDER BY ${order}
			</when>
			<otherwise>
				ORDER BY expend_date DESC
			</otherwise>
		</choose>
	</select>

	<insert id="BudgetMaria.insertBudgetTemp" parameterType="map">
		INSERT INTO DJ_EPIS.BUDGET_TEMP
		(
			ISU_DT,
		 	ISU_SQ,
		 	FILL_SEQ,
			APPRO_KEY,
		 	REG_DATE
		)
		VALUES
		(
			#{isuDt},
		 	#{isuSq},
	 		#{fillSeq},
		 	#{approKey},
		 	NOW()
		)
	</insert>

	<update id="BudgetMaria.updateBudgetTemp" parameterType="map">
		UPDATE DJ_EPIS.BUDGET_TEMP
		SET APPR_STATUS = #{docSts},
			DOC_ID = #{docId},
			MOD_DATE = NOW()
		WHERE APPRO_KEY = #{approKey}
	</update>

	<select id="BudgetMaria.getAdocuDocInfoTempList" parameterType="map" resultType="map">
		SELECT
		    *,
			LEFT(fill_seq, 8) AS FILL_DT,
		    RIGHT(fill_seq, 5) AS FILL_NB
		FROM
		    DJ_EPIS.BUDGET_TEMP
		WHERE APPR_STATUS IN('20', '80', '90', '100')
		AND APPRO_KEY = concat('DJADOCUEA_', #{ISU_DT}, '_', #{ISU_SQ})
	</select>
</mapper>